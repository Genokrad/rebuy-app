// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Note that some adapters may set a maximum length for the String type by default, please ensure your strings are long
// enough when changing adapters.
// See https://www.prisma.io/docs/orm/reference/prisma-schema-reference#string for more information
datasource db {
  provider = "sqlite"
  url      = "file:dev.sqlite"
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

model Widget {
  id          String         @id @default(cuid())
  name        String
  type        String         // "products-page", "cart", "checkout"
  shop        String         // shop domain
  products    String?        // JSON string with product relationships (deprecated, kept for migration)
  settings    String?        // JSON string with widget settings (discounts, slideCount, etc.)
  widgetProducts WidgetProduct[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([shop])
}

model WidgetProduct {
  id              String              @id @default(cuid())
  widgetId        String
  parentProductId String              // Shopify product ID
  order           Int?                // порядок отображения
  widget          Widget              @relation(fields: [widgetId], references: [id], onDelete: Cascade)
  childProducts   WidgetChildProduct[]
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([widgetId])
  @@index([parentProductId])
}

model WidgetChildProduct {
  id              String        @id @default(cuid())
  widgetProductId String
  childProductId  String
  order           Int?          // порядок отображения в виджете
  widgetProduct   WidgetProduct @relation(fields: [widgetProductId], references: [id], onDelete: Cascade)
  childProduct    ChildProduct  @relation(fields: [childProductId], references: [id], onDelete: Cascade)

  @@unique([widgetProductId, childProductId])
  @@index([childProductId])
  @@index([widgetProductId])
}

model ChildProduct {
  id            String              @id @default(cuid())
  variantId     String              // Shopify variant ID (уникальный)
  productId     String              // Shopify product ID
  variantDetails VariantDetails?
  widgetLinks   WidgetChildProduct[]

  @@unique([variantId])
  @@index([productId])
}

model VariantDetails {
  id              String          @id @default(cuid())
  childProductId  String          @unique
  childProduct    ChildProduct    @relation(fields: [childProductId], references: [id], onDelete: Cascade)
  inventoryQuantity Int
  availableForSale Boolean
  inventoryPolicy  String
  variantId        String
  title            String
  price            String
  compareAtPrice   String?
  imageUrl         String?
  productId        String
  productTitle     String
  inventoryLevels  InventoryLevel[]
  marketPrices     MarketPrice[]
  updatedAt        DateTime       @updatedAt

  @@index([variantId])
  @@index([childProductId])
}

model InventoryLevel {
  id              String        @id @default(cuid())
  variantDetailsId String
  variantDetails  VariantDetails @relation(fields: [variantDetailsId], references: [id], onDelete: Cascade)
  locationId      String
  locationName    String
  countryCode     String
  quantity        Int
  shipsInventory  Boolean
  price           String
  compareAtPrice  String?
  currencyCode    String
  marketId        String?
  marketName      String?
  locale          String?
  updatedAt       DateTime      @updatedAt

  @@unique([variantDetailsId, locationId])
  @@index([countryCode])
  @@index([marketId])
  @@index([variantDetailsId])
}

model MarketPrice {
  id              String        @id @default(cuid())
  variantDetailsId String
  variantDetails  VariantDetails @relation(fields: [variantDetailsId], references: [id], onDelete: Cascade)
  marketId        String
  marketName      String
  countryCode     String
  price           String
  compareAtPrice  String?
  currencyCode    String
  updatedAt       DateTime      @updatedAt

  @@unique([variantDetailsId, marketId])
  @@index([marketId])
  @@index([countryCode])
  @@index([variantDetailsId])
}

model ShopOrderMetric {
  id                 String              @id @default(cuid())
  shop               String
  orderId            String
  orderName          String?
  currency           String?
  totalPrice         String?
  subtotalPrice      String?
  totalDiscounts     String?
  totalTax           String?
  pluginInvolved     Boolean             @default(false)
  pluginRevenue      String?
  pluginDiscountTotal String?
  orderCreatedAt     DateTime?
  rawPayload         Json?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  lineItems          ShopOrderLineItem[]

  @@unique([shop, orderId])
  @@index([shop])
  @@index([shop, pluginInvolved])
  @@index([orderCreatedAt])
}

model ShopOrderLineItem {
  id                 String           @id @default(cuid())
  orderMetricId      String
  order              ShopOrderMetric  @relation(fields: [orderMetricId], references: [id], onDelete: Cascade)
  lineItemId         String
  productId          String?
  variantId          String?
  title              String?
  variantTitle       String?
  quantity           Int
  price              String?
  linePrice          String?
  discountedPrice    String?
  discountAllocations Json?
  properties         Json?
  widgetId           String?
  widgetType         String?
  sellenceDiscount   Boolean          @default(false)
  createdAt          DateTime         @default(now())

  @@index([orderMetricId])
  @@index([sellenceDiscount])
}

model WidgetClickEvent {
  id         String   @id @default(cuid())
  shop       String
  widgetId   String
  widgetType String
  createdAt  DateTime @default(now())

  @@index([shop])
  @@index([widgetId])
  @@index([widgetType])
}
