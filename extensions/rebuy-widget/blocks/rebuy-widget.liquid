{% comment %}
  Rebuy Widget Block - Simple Start
{% endcomment %}

<!-- Подключаем Tailwind CSS -->
{% comment %} <script src="https://cdn.tailwindcss.com"></script> {% endcomment %}

<!-- Splide.js CSS -->
{% comment %} theme-check-disable RemoteAsset {% endcomment %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/css/splide.min.css">

<!-- Splide.js JavaScript -->
{% comment %} theme-check-disable RemoteAsset {% endcomment %}
<script src="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/js/splide.min.js"></script>

<style>

  .product__media-wrapper {
    max-width: 50% !important;
  }

  .product__info-wrapper {
    max-width: 50% !important;
  }
  #sellence-widget-content {
    background-color: #f5f5ee;
    padding: 36px;
    border-radius:16px;
    display: flex;
    flex-direction: column;
  }

  /* Стили для слайдера */
  .sellence-products-slider {
    width: 100%;
  }

  .sellence-products-slider .splide__slide {
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
  }

  .sellence-products-slider .splide__slide:not(:last-child)::after {
    content: '+';
    position: absolute;
    right: -15px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 20px;
    font-weight: bold;
    color: #666;
    z-index: 10;
  }

  .sellence-pdp-widget-product-image {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .sellence-pdp-widget-product-image img {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 8px;
  }

  /* Скрываем стандартные элементы управления Splide */
  .sellence-products-slider .splide__pagination {
    display: none !important;
  }

  .sellence-products-slider .splide__arrows {
    display: none !important;
  }

  .sellence-widget-title {
    font-size: 27px;
    font-weight: 500;
    margin: 0;
    color: #232323;
    line-height: 1;
    margin-bottom: 20px;
  }

  /* Стили для списка товаров */
  .sellence-widget-this-item-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .sellence-widget-item {
    margin: 0;
  }

  .sellence-widget-item-label {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    cursor: pointer;
    padding: 8px 0;
  }

  .sellence-widget-checkbox {
    display: none;
  }

  .sellence-widget-checkmark {
    width: 20px;
    height: 20px;
    background-color: #000;
    border-radius: 3px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-top: 2px;
  }

  .sellence-widget-checkmark::after {
    content: '✓';
    color: white;
    font-size: 14px;
    font-weight: bold;
  }

  .sellence-widget-checkbox:not(:checked) + .sellence-widget-checkmark {
    background-color: transparent;
    border: 2px solid #ccc;
  }

  .sellence-widget-checkbox:not(:checked) + .sellence-widget-checkmark::after {
    display: none;
  }

  .sellence-widget-item-content {
    display: flex;
    /* flex-direction: column; */
    gap: 16px;
    flex: 1;
  }

  .sellence-widget-item-name {
    font-size: 14px;
    color: #333;
    text-decoration: underline;
    line-height: 1.3;
  }

  .sellence-widget-item-price {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .sellence-widget-price-new {
    font-size: 14px;
    font-weight: 600;
    color: #e74c3c;
    margin: 0;
  }

  .sellence-widget-price-currency-code {
    font-size: 14px;
    font-weight: 600;
    color: #e74c3c;
  }

  .sellence-widget-price-old-currency-code {
    font-size: 14px;
    color: #999;
    text-decoration: line-through;
  }

  .sellence-widget-price-old {
    font-size: 14px;
    color: #999;
    text-decoration: line-through;
    margin: 0;
  }
  
  .sellence-widget-checkbox {
    display: none !important;
  }

  .sellence-widget-add-to-cart {
    padding: 10px 15px;
    width: 100%;
    height: auto;
    text-align: center;
    font-size: 16px;
    border-style: solid;
    border-width: 1px;
    border-color: #000;
    background-color: transparent;
    color: #000;
    font-weight: 500;
    cursor: pointer;
    width: 50%;
    margin-bottom: 20px;
  }

  .rebuy-product-label {
    font-size: 16px;
    font-weight: 500;
    color: #000;
    line-height: 1;
    margin: 0;
    margin-bottom: 16px;
  }

  .sellence-widget-total-price {
    font-size: 15px;
    font-weight: 600;
    margin-left: 16px;
  }

  .sellence-widget-total-price-new {
    font-weight: 400;
    color: red;
  }

  .sellence-widget-total-price-old {
    font-weight: 400;
    color: #8e8e8e;
    text-decoration: line-through;
  }
</style>

<div class="sellence-widget" id="sellence-widget-{{ block.id }}">
  <div id="sellence-widget-content" class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
    <h2 class="sellence-widget-title">Buy more at a lower price</h2>

    <!-- Splide.js слайдер -->
    <div class="splide sellence-products-slider" id="products-slider">
      <div class="splide__track">
        <ul class="splide__list" id="products-list">
          <!-- Товары будут добавлены динамически через JavaScript -->
        </ul>
      </div>
    </div>

    <p class="sellence-widget-total-price">Total Price:
      <span class="sellence-widget-total-price-new">$395.20</span>
      <span class="sellence-widget-total-price-old">$416.00</span>
    </p>

    <button class="sellence-widget-add-to-cart">Add all</button>

    <strong class="rebuy-product-label">This item:</strong>

    <ul class="sellence-widget-this-item-list" id="items-list">
      <!-- Товары будут добавлены динамически через JavaScript -->
    </ul>
  </div>
</div>

<script>

  // console.log('{{ market.country_code | default: "US" }}');

  const CURRENCY_SYMBOLS = {
    'USD': '$', 'EUR': '€', 'GBP': '£', 'JPY': '¥', 'CAD': 'C$',
    'AUD': 'A$', 'CHF': 'CHF', 'CNY': '¥', 'SEK': 'kr', 'NOK': 'kr',
    'DKK': 'kr', 'PLN': 'zł', 'CZK': 'Kč', 'HUF': 'Ft', 'RUB': '₽',
    'BRL': 'R$', 'INR': '₹', 'KRW': '₩', 'SGD': 'S$', 'HKD': 'HK$',
    'NZD': 'NZ$', 'MXN': '$', 'ZAR': 'R', 'TRY': '₺', 'ILS': '₪',
    'AED': 'د.إ', 'SAR': '﷼', 'THB': '฿', 'MYR': 'RM', 'PHP': '₱',
    'IDR': 'Rp', 'VND': '₫', 'EGP': '£', 'NGN': '₦', 'KES': 'KSh',
    'GHS': '₵', 'MAD': 'د.م.', 'TND': 'د.ت', 'DZD': 'د.ج', 'LBP': 'ل.ل',
    'JOD': 'د.ا', 'KWD': 'د.ك', 'BHD': 'د.ب', 'QAR': 'ر.ق', 'OMR': 'ر.ع.',
    'YER': '﷼', 'IQD': 'د.ع', 'AFN': '؋', 'PKR': '₨', 'BDT': '৳',
    'LKR': '₨', 'NPR': '₨', 'MMK': 'K', 'KHR': '៛', 'LAK': '₭',
    'BND': 'B$', 'FJD': 'FJ$', 'PGK': 'K', 'SBD': 'SI$', 'VUV': 'Vt',
    'WST': 'WS$', 'TOP': 'T$', 'BTN': 'Nu.', 'MVR': 'ރ.', 'SCR': '₨',
    'MUR': '₨', 'KMF': 'CF', 'DJF': 'Fdj', 'ETB': 'Br', 'SOS': 'S',
    'TZS': 'TSh', 'UGX': 'USh', 'RWF': 'RF', 'BIF': 'FBu', 'MWK': 'MK',
    'ZMW': 'ZK', 'BWP': 'P', 'SZL': 'L', 'LSL': 'L', 'NAD': 'N$',
    'AOA': 'Kz', 'MZN': 'MT', 'MGA': 'Ar', 'CDF': 'FC', 'XAF': 'FCFA',
    'XOF': 'CFA', 'GMD': 'D', 'GNF': 'FG', 'LRD': 'L$', 'SLL': 'Le',
    'CVE': '$', 'STN': 'Db', 'ERN': 'Nfk', 'SDG': 'ج.س.', 'SSP': '£',
    'LYD': 'ل.د', 'MRO': 'UM', 'MRU': 'UM', 'XPF': '₣', 'NIO': 'C$',
    'GTQ': 'Q', 'HNL': 'L', 'SVC': '$', 'BZD': 'BZ$', 'JMD': 'J$',
    'TTD': 'TT$', 'BBD': 'Bds$', 'XCD': '$', 'AWG': 'ƒ', 'ANG': 'ƒ',
    'SRD': '$', 'GYD': 'G$', 'VES': 'Bs.S', 'COP': '$', 'PEN': 'S/',
    'BOB': 'Bs', 'CLP': '$', 'ARS': '$', 'UYU': '$U', 'PYG': '₲',
    'FKP': '£', 'GIP': '£', 'ISK': 'kr', 'RON': 'lei', 'BGN': 'лв',
    'HRK': 'kn', 'RSD': 'дин.', 'MKD': 'ден', 'ALL': 'L', 'BAM': 'КМ',
    'MDL': 'L', 'UAH': '₴', 'BYN': 'Br', 'AMD': '֏', 'GEL': '₾',
    'AZN': '₼', 'KZT': '₸', 'KGS': 'с', 'TJS': 'SM', 'TMT': 'T',
    'UZS': 'лв', 'MNT': '₮'
  };

  function getCurrencySymbol(currencyCode) {
    if (!currencyCode) return '';
    const symbol = CURRENCY_SYMBOLS[currencyCode.toUpperCase()];
    return symbol || currencyCode;
  }

  function formatWidgetPrice(amount, currencyCode) {
    const numericAmount = typeof amount === 'string' ? parseFloat(amount) : amount;
    if (isNaN(numericAmount)) return '0';

    console.log('numericAmount:', numericAmount);

    const formattedAmount = numericAmount.toFixed(2);
    const symbol = getCurrencySymbol(currencyCode);

    return `${symbol}${formattedAmount}`;
  }

  (function() {
    const widgetId = '{{ block.settings.widget_id }}';
    const appUrl = '{{ block.settings.app_url }}';
    const currentProductId = '{{ product.id }}';
    const statusElement = document.getElementById('sellence-status-{{ block.id }}');
    const contentElement = document.getElementById('sellence-widget-content-{{ block.id }}');
    let howManyProductsPicked = 0;

    // Инициализация Splide.js слайдера
    function initSlider() {
      if (typeof Splide !== 'undefined') {
        new Splide('#products-slider', {
          type: 'slide',
          perPage: 4,
          perMove: 1,
          gap: '20px',
          // padding: '10px',
          arrows: false,
          pagination: false,
          drag: true,
          snap: true,
          breakpoints: {
            768: {
              perPage: 2,
            },
            480: {
              perPage: 1,
            }
          }
        }).mount();
      }
    }

    // Инициализируем слайдер после загрузки DOM
    document.addEventListener('DOMContentLoaded', initSlider);

    async function loadWidget() {
      try {
        const cleanUrl = appUrl.replace(/\/$/, '');
        const apiUrl = cleanUrl + '/api/widget/' + widgetId + '?productId=' + encodeURIComponent(currentProductId);

        const response = await fetch(apiUrl);

        if (!response.ok) {
          throw new Error('HTTP error! status: ' + response.status);
        }

        const data = await response.json();

        const initializeWidget = (widget) => {
          const productSelectedCount = widget.product.childProducts.length;
          const sortedDiscounts = widget.settings.discounts
          let finalDiscount = 0;
          const arraySortedDiscounts = sortedDiscounts.forEach(discount => {
            if (productSelectedCount >= Number(Object.entries(discount)[0][0])) {
              finalDiscount = Number(Object.entries(discount)[0][1]);
            }
          });

          console.log('finalDiscount: ===>>>', finalDiscount);
          console.log('Widget data:', widget);
          // Получаем текущий маркетплейс
          const currentMarketplace = document.getElementById('sellence-widget-{{ block.id }}').dataset.currentMarketplace || 'US';
          // console.log('Current marketplace:', currentMarketplace);

          // Инициализируем слайдер с товарами
          initializeProductsSlider(widget, currentMarketplace);

          // Инициализируем список товаров
          initializeItemsList(widget, currentMarketplace, finalDiscount);

          // Обновляем общую цену
          updateTotalPrice(widget, currentMarketplace, finalDiscount);
        }

        // Функция для создания слайдера с товарами
        function initializeProductsSlider(widget, currentMarketplace) {
          const productsList = document.getElementById('products-list');
          if (!productsList || !widget.product?.childProducts) return;

          // Очищаем список
          productsList.innerHTML = '';

          // Добавляем товары в слайдер
          widget.product.childProducts.forEach((childProduct, index) => {
            const slide = document.createElement('li');
            slide.className = 'splide__slide';

            // Получаем цену для текущего маркетплейса
            const inventoryLevel = childProduct.variantDetails?.inventoryLevels?.find(
              level => level.countryCode === currentMarketplace
            ) || childProduct.variantDetails?.inventoryLevels?.[0];

            const imageUrl = childProduct.variantDetails?.image?.url || 
                           'https://via.placeholder.com/120x120?text=No+Image';

            slide.innerHTML = `
              <div class="sellence-pdp-widget-product-image">
                <img src="${imageUrl}" alt="Product ${index + 1}" width="120" height="120">
              </div>
            `;

            productsList.appendChild(slide);
          });

          // Переинициализируем слайдер
          if (typeof Splide !== 'undefined') {
            const splideElement = document.querySelector('#products-slider');
            if (splideElement) {
              // Уничтожаем существующий слайдер если есть
              if (splideElement.splide) {
                splideElement.splide.destroy();
              }

              // Создаем новый слайдер
              new Splide('#products-slider', {
                type: 'slide',
                perPage: Math.min(4, widget.product.childProducts.length),
                perMove: 1,
                gap: '20px',
                arrows: false,
                pagination: false,
                drag: true,
                snap: true,
                breakpoints: {
                  768: {
                    perPage: Math.min(2, widget.product.childProducts.length),
                  },
                  480: {
                    perPage: 1,
                  }
                }
              }).mount();
            }
          }
        }

        // Функция для создания списка товаров
        function initializeItemsList(widget, currentMarketplace, finalDiscount) {
          const itemsList = document.getElementById('items-list');
          if (!itemsList || !widget.product?.childProducts) return;

          // Очищаем список
          itemsList.innerHTML = '';

          // Добавляем товары в список
          widget.product.childProducts.forEach((childProduct, index) => {
            const item = document.createElement('li');
            item.className = 'sellence-widget-item';

            // Получаем цену для текущего маркетплейса
            const inventoryLevel = childProduct.variantDetails?.inventoryLevels?.find(
              level => level.countryCode === currentMarketplace
            ) || childProduct.variantDetails?.inventoryLevels?.[0];

            const price = inventoryLevel?.price || childProduct.variantDetails?.price || '0';
            const currencyCode = inventoryLevel?.currencyCode || 'USD';
            const compareAtPrice = childProduct.variantDetails?.compareAtPrice;

            // Получаем название товара из данных варианта
            const productName = childProduct.variantDetails?.title || 
                               childProduct.variantDetails?.product?.title || 
                               `Product ${index + 1}`;

            // Форматируем цены с символами валют
            const formattedPrice = formatWidgetPrice(price, currencyCode);
            const formattedPriceWithDiscount = formatWidgetPrice(price * (1 - finalDiscount / 100), currencyCode);
            const formattedComparePrice = compareAtPrice ? formatWidgetPrice(compareAtPrice, currencyCode) : '';
            // console.log('formattedPrice compare price:', formattedPrice);
            // const newPrice = 
            
            // console.log('sortedDiscounts:', sortedDiscounts);

            item.innerHTML = `
              <label class="sellence-widget-item-label">
                <input type="checkbox" class="sellence-widget-checkbox" checked>
                <span class="sellence-widget-checkmark"></span>
                <div class="sellence-widget-item-content">
                  <span class="sellence-widget-item-name">${productName}</span>
                  <div class="sellence-widget-item-price">
                    <p class="sellence-widget-price-new">Now: <span class="sellence-widget-price-new">${formattedPriceWithDiscount}</span></p>
                    <p class="sellence-widget-price-old">Was: <span class="sellence-widget-price-old-price">${formattedPrice}</span></p>
                  </div>
                </div>
              </label>
            `;

            itemsList.appendChild(item);
          });

          howManyProductsPicked = widget?.product?.childProducts?.length || 0;
          console.log('How many products picked:', howManyProductsPicked);
        }

        // Функция для обновления общей цены
        function updateTotalPrice(widget, currentMarketplace, finalDiscount) {
          const totalPriceNew = document.querySelector('.sellence-widget-total-price-new');
          const totalPriceOld = document.querySelector('.sellence-widget-total-price-old');

          if (!totalPriceNew || !widget.product?.childProducts) return;

          let totalNew = 0;
          let totalOld = 0;
          let currencyCode = 'USD';

          widget.product.childProducts.forEach(childProduct => {
            const inventoryLevel = childProduct.variantDetails?.inventoryLevels?.find(
              level => level.countryCode === currentMarketplace
            ) || childProduct.variantDetails?.inventoryLevels?.[0];

            const price = parseFloat(inventoryLevel?.price || childProduct.variantDetails?.price || '0');
            const compareAtPrice = parseFloat(childProduct.variantDetails?.compareAtPrice || '0');

            // Используем валюту из первого товара
            if (inventoryLevel?.currencyCode) {
              currencyCode = inventoryLevel.currencyCode;
            }

            totalNew += price;
            totalOld += price;
            // if (compareAtPrice > 0) {
            //   totalOld += compareAtPrice;
            // }
          });

          console.log('totalNew: <<<<<<<<<', totalNew);

          totalPriceNew.textContent = formatWidgetPrice(totalNew * (1 - finalDiscount / 100), currencyCode);
          if (totalOld > 0) {
            totalPriceOld.textContent = formatWidgetPrice(totalOld, currencyCode);
            totalPriceOld.style.display = 'inline';
          } else {
            totalPriceOld.style.display = 'none';
          }
        }

        const productPagePlacement = data?.widget?.settings?.placements?.includes('products');

        if (data?.widget?.product?.parentProduct && productPagePlacement) {
          initializeWidget(data.widget);
        }

      } catch (error) {
        console.error('Error loading widget:', error);
        statusElement.innerHTML = '❌ Ошибка: ' + error.message;
        statusElement.className = 'text-red-600 font-medium';
      }
    }

    loadWidget();
  })();
</script>

{% schema %}
{
  "name": "Rebuy Widget",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "widget_id",
      "label": "Widget ID",
      "info": "Enter the Widget ID from your Rebuy app admin panel"
    },
    {
      "type": "text",
      "id": "app_url",
      "label": "App URL",
      "info": "Your app URL from terminal (e.g., https://abc123.cloudflare-tunnel.com)",
      "placeholder": "https://your-tunnel-url.com"
    }
  ]
}
{% endschema %}