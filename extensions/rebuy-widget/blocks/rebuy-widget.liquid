{% comment %}
  Rebuy Widget Block - Simple Start
{% endcomment %}

<div class="rebuy-widget" id="rebuy-widget-{{ block.id }}">
  <h2>–ü—Ä–∏–≤–µ—Ç!!</h2>
  <p id="rebuy-status-{{ block.id }}">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
</div>

<style>
  .rebuy-widget {
    padding: 20px;
    text-align: center;
    background: #f0f8ff;
    border: 2px solid #2c6ecb;
    border-radius: 8px;
    margin: 20px 0;
  }

  .rebuy-widget h2 {
    font-size: 24px;
    color: #2c6ecb;
    margin: 0;
  }

  .rebuy-widget p {
    margin: 10px 0 0 0;
    font-size: 14px;
    color: #666;
  }
</style>

<script>
(function() {
  const widgetId = '{{ block.settings.widget_id }}';
  const appUrl = '{{ block.settings.app_url }}';
  const currentProductId = '{{ product.id }}';
  const statusElement = document.getElementById('rebuy-status-{{ block.id }}');

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  if (!widgetId) {
    statusElement.innerHTML = '‚ùå Widget ID –Ω–µ —É–∫–∞–∑–∞–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±–ª–æ–∫–∞';
    statusElement.style.color = 'red';
    return;
  }

  if (!appUrl) {
    statusElement.innerHTML = '‚ùå App URL –Ω–µ —É–∫–∞–∑–∞–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±–ª–æ–∫–∞';
    statusElement.style.color = 'red';
    return;
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤–∏–¥–∂–µ—Ç–∞
  async function loadWidget() {
    try {
      statusElement.innerHTML = '‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤–∏–¥–∂–µ—Ç–∞...';
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è API
      const cleanUrl = appUrl.replace(/\/$/, '');
      const apiUrl = cleanUrl + '/api/widget/' + widgetId + '?productId=' + encodeURIComponent(currentProductId);
      
      const response = await fetch(apiUrl);
      
      if (!response.ok) {
        throw new Error('HTTP error! status: ' + response.status);
      }

      const data = await response.json();
      
      // –í—ã–≤–æ–¥–∏–º –í–°–ï –¥–∞–Ω–Ω—ã–µ –≤–∏–¥–∂–µ—Ç–∞ –≤ –∫–æ–Ω—Å–æ–ª—å
      console.log('==============================================');
      console.log('üì¶ WIDGET DATA LOADED:');
      console.log('==============================================');
      console.log('Full Response:', data);
      console.log('');
      console.log('Widget Object:', data.widget);
      console.log('  - ID:', data.widget.id);
      console.log('  - Name:', data.widget.name);
      console.log('  - Type:', data.widget.type);
      console.log('  - Shop:', data.widget.shop);
      console.log('  - Product:', data.widget.product);
      console.log('  - Created At:', data.widget.createdAt);
      console.log('');
      console.log('Current Product ID:', data.currentProductId);
      console.log('==============================================');

      statusElement.innerHTML = '‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã! –°–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12)';
      statusElement.style.color = 'green';
      
    } catch (error) {
      console.error('Error loading widget:', error);
      statusElement.innerHTML = '‚ùå –û—à–∏–±–∫–∞: ' + error.message;
      statusElement.style.color = 'red';
    }
  }

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
  loadWidget();
})();
</script>

{% schema %}
{
  "name": "Rebuy Widget",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "widget_id",
      "label": "Widget ID",
      "info": "Enter the Widget ID from your Rebuy app admin panel"
    },
    {
      "type": "text",
      "id": "app_url",
      "label": "App URL",
      "info": "Your app URL from terminal (e.g., https://abc123.cloudflare-tunnel.com)",
      "placeholder": "https://your-tunnel-url.com"
    }
  ]
}
{% endschema %}

