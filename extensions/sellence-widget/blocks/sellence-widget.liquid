{% comment %}
  Sellence Widget Block - Simple Start
{% endcomment %}

<!-- Splide.js CSS -->
{% comment %} theme-check-disable RemoteAsset {% endcomment %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/css/splide.min.css">

<!-- Splide.js JavaScript -->
{% comment %} theme-check-disable RemoteAsset {% endcomment %}
<script defer src="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/js/splide.min.js"></script>

<style>
  .sellence-widget-{{ block.settings.widget_id }} {
    display: none;
    margin-top: 16px;
    margin-bottom: 16px;
  }
  .product__media-wrapper {
    max-width: 50% !important;
  }

  .product__info-wrapper {
    max-width: 50% !important;
  }
  #sellence-widget-content {
    background-color: #f5f5ee;
    padding: 36px;
    border-radius:16px;
    display: flex;
    flex-direction: column;
  }

  /* Стили для слайдера */
  .sellence-products-slider {
    width: 100%;
  }

  .sellence-products-slider .splide__slide {
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
  }

  .sellence-products-slider .splide__slide:not(:last-child)::after {
    content: '+';
    position: absolute;
    right: -15px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 20px;
    font-weight: bold;
    color: #666;
    z-index: 10;
  }

  .sellence-pdp-widget-product-image {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .sellence-pdp-widget-product-image img {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 8px;
  }

  /* Скрываем стандартные элементы управления Splide */
  .sellence-products-slider .splide__pagination {
    display: none !important;
  }

  .sellence-products-slider .splide__arrows {
    display: none !important;
  }

  .sellence-widget-title {
    font-size: 27px;
    font-weight: 500;
    margin: 0;
    color: #232323;
    line-height: 1;
    margin-bottom: 20px;
  }

  /* Стили для списка товаров */
  .sellence-widget-this-item-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .sellence-widget-item {
    margin: 0;
  }

  .sellence-widget-item-label {
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    padding: 8px 0;
    margin: 0;
  }

  .sellence-widget-checkbox {
    display: none;
  }

  .sellence-widget-checkmark {
    width: 20px;
    height: 20px;
    background-color: #000;
    border-radius: 3px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-top: 2px;
  }

  .sellence-widget-checkmark::after {
    content: '✓';
    color: white;
    font-size: 14px;
    font-weight: bold;
  }

  .sellence-widget-checkbox:not(:checked) + .sellence-widget-checkmark {
    background-color: transparent;
    border: 2px solid #ccc;
  }

  .sellence-widget-checkbox:not(:checked) + .sellence-widget-checkmark::after {
    display: none;
  }

  .sellence-widget-item-content {
    display: flex;
    justify-content: space-between;
    /* flex-direction: column; */
    gap: 16px;
    flex: 1;
    width: 100%;
  }

  .sellence-widget-item-name {
    font-size: 14px;
    color: #333;
    text-decoration: underline;
    line-height: 1.3;
    display: flex;
    align-items: center;
  }

  .sellence-widget-item-price {
    display: flex;
    align-items: center;
    flex-direction: column;
    gap: 8px;
  }

  .sellence-widget-price-new {
    font-size: 14px;
    font-weight: 600;
    color: #e74c3c;
    margin: 0;
  }

  .sellence-widget-price-currency-code {
    font-size: 14px;
    font-weight: 600;
    color: #e74c3c;
  }

  .sellence-widget-price-old-currency-code {
    font-size: 14px;
    color: #999;
    text-decoration: line-through;
  }

  .sellence-widget-price-old {
    font-size: 14px;
    color: #999;
    text-decoration: line-through;
    margin: 0;
    display: flex;
    gap: 2px;
  }
  
  .sellence-widget-checkbox {
    display: none !important;
  }

  .sellence-widget-add-to-cart {
    padding: 10px 15px;
    width: 100%;
    height: auto;
    text-align: center;
    font-size: 16px;
    border-style: solid;
    border-width: 1px;
    border-color: #000;
    background-color: transparent;
    color: #000;
    font-weight: 500;
    cursor: pointer;
    width: 50%;
    margin-bottom: 20px;

    @media (max-width: 1024px) {
      width: 100%;
    }
  }

  .sellence-widget-product-label {
    font-size: 16px;
    font-weight: 500;
    color: #000;
    line-height: 1;
    margin: 0;
    margin-bottom: 16px;
  }

  .sellence-widget-total-price {
    margin-top: 16px;
    font-size: 15px;
    font-weight: 600;
    /* margin-left: 16px; */
  }

  .sellence-widget-total-price-new {
    font-weight: 400;
    color: red;
  }

  .sellence-widget-total-price-old {
    font-weight: 400;
    color: #8e8e8e;
    text-decoration: line-through;
  }
</style>

<div class="sellence-widget d sellence-widget-{{ block.settings.widget_id }}" id="sellence-widget-{{ block.id }}" data-current-marketplace="{{ localization.country.iso_code }}">
  <div id="sellence-widget-content" class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
    <h2 class="sellence-widget-title">{{ 'sellence-widget.title' | t }}</h2>

    <!-- Splide.js слайдер -->
    <div class="splide sellence-products-slider" id="products-slider">
      <div class="splide__track">
        <ul class="splide__list" id="products-list">
          <!-- Товары будут добавлены динамически через JavaScript -->
        </ul>
      </div>
    </div>

    <p class="sellence-widget-total-price">{{ 'sellence-widget.total_price' | t }}
      <span class="sellence-widget-total-price-new"></span>
      <span class="sellence-widget-total-price-old"></span>
    </p>

    <button class="sellence-widget-add-to-cart">{{ 'sellence-widget.add_all' | t }}</button>

    <strong class="sellence-widget-product-label">{{ 'sellence-widget.this_item' | t }}</strong>

    <ul class="sellence-widget-this-item-list" id="items-list">
      <!-- Товары будут добавлены динамически через JavaScript -->
    </ul>
  </div>
</div>

<script>
  const CURRENCY_SYMBOLS = {
    'USD': '$', 'EUR': '€', 'GBP': '£', 'JPY': '¥', 'CAD': 'C$',
    'AUD': 'A$', 'CHF': 'CHF', 'CNY': '¥', 'SEK': 'kr', 'NOK': 'kr',
    'DKK': 'kr', 'PLN': 'zł', 'CZK': 'Kč', 'HUF': 'Ft', 'RUB': '₽',
    'BRL': 'R$', 'INR': '₹', 'KRW': '₩', 'SGD': 'S$', 'HKD': 'HK$',
    'NZD': 'NZ$', 'MXN': '$', 'ZAR': 'R', 'TRY': '₺', 'ILS': '₪',
    'AED': 'د.إ', 'SAR': '﷼', 'THB': '฿', 'MYR': 'RM', 'PHP': '₱',
    'IDR': 'Rp', 'VND': '₫', 'EGP': '£', 'NGN': '₦', 'KES': 'KSh',
    'GHS': '₵', 'MAD': 'د.م.', 'TND': 'د.ت', 'DZD': 'د.ج', 'LBP': 'ل.ل',
    'JOD': 'د.ا', 'KWD': 'د.ك', 'BHD': 'د.ب', 'QAR': 'ر.ق', 'OMR': 'ر.ع.',
    'YER': '﷼', 'IQD': 'د.ع', 'AFN': '؋', 'PKR': '₨', 'BDT': '৳',
    'LKR': '₨', 'NPR': '₨', 'MMK': 'K', 'KHR': '៛', 'LAK': '₭',
    'BND': 'B$', 'FJD': 'FJ$', 'PGK': 'K', 'SBD': 'SI$', 'VUV': 'Vt',
    'WST': 'WS$', 'TOP': 'T$', 'BTN': 'Nu.', 'MVR': 'ރ.', 'SCR': '₨',
    'MUR': '₨', 'KMF': 'CF', 'DJF': 'Fdj', 'ETB': 'Br', 'SOS': 'S',
    'TZS': 'TSh', 'UGX': 'USh', 'RWF': 'RF', 'BIF': 'FBu', 'MWK': 'MK',
    'ZMW': 'ZK', 'BWP': 'P', 'SZL': 'L', 'LSL': 'L', 'NAD': 'N$',
    'AOA': 'Kz', 'MZN': 'MT', 'MGA': 'Ar', 'CDF': 'FC', 'XAF': 'FCFA',
    'XOF': 'CFA', 'GMD': 'D', 'GNF': 'FG', 'LRD': 'L$', 'SLL': 'Le',
    'CVE': '$', 'STN': 'Db', 'ERN': 'Nfk', 'SDG': 'ج.س.', 'SSP': '£',
    'LYD': 'ل.د', 'MRO': 'UM', 'MRU': 'UM', 'XPF': '₣', 'NIO': 'C$',
    'GTQ': 'Q', 'HNL': 'L', 'SVC': '$', 'BZD': 'BZ$', 'JMD': 'J$',
    'TTD': 'TT$', 'BBD': 'Bds$', 'XCD': '$', 'AWG': 'ƒ', 'ANG': 'ƒ',
    'SRD': '$', 'GYD': 'G$', 'VES': 'Bs.S', 'COP': '$', 'PEN': 'S/',
    'BOB': 'Bs', 'CLP': '$', 'ARS': '$', 'UYU': '$U', 'PYG': '₲',
    'FKP': '£', 'GIP': '£', 'ISK': 'kr', 'RON': 'lei', 'BGN': 'лв',
    'HRK': 'kn', 'RSD': 'дин.', 'MKD': 'ден', 'ALL': 'L', 'BAM': 'КМ',
    'MDL': 'L', 'UAH': '₴', 'BYN': 'Br', 'AMD': '֏', 'GEL': '₾',
    'AZN': '₼', 'KZT': '₸', 'KGS': 'с', 'TJS': 'SM', 'TMT': 'T',
    'UZS': 'лв', 'MNT': '₮'
  };

  const I18N = {
    nowLabel: {{ 'sellence-widget.price_now' | t | json }},
    wasLabel: {{ 'sellence-widget.price_was' | t | json }},
    addMorePrompt: {{ 'sellence-widget.add_more_prompt' | t | json }},
    addOnePrompt: {{ 'sellence-widget.add_one_prompt' | t | json }},
    productPlaceholder: {{ 'sellence-widget.product_placeholder' | t | json }},
    addToCartError: {{ 'sellence-widget.add_to_cart_error' | t | json }},
    noImageAlt: {{ 'sellence-widget.no_image_alt' | t | json }}
  };

  function getCurrencySymbol(currencyCode) {
    if (!currencyCode) return '';
    const symbol = CURRENCY_SYMBOLS[currencyCode.toUpperCase()];
    return symbol || currencyCode;
  }

  function formatWidgetPrice(amount, currencyCode) {
    const numericAmount = typeof amount === 'string' ? parseFloat(amount) : amount;
    if (isNaN(numericAmount)) return '0';

    console.log('numericAmount:', numericAmount);

    const formattedAmount = numericAmount.toFixed(2);
    const symbol = getCurrencySymbol(currencyCode);

    return `${symbol}${formattedAmount}`;
  }

  function getFinalDiscount(productSelectedCount, sortedDiscounts) {
    let finalDiscount = 0;
    sortedDiscounts.forEach(discount => {
      if (productSelectedCount >= Number(Object.entries(discount)[0][0])) {
        finalDiscount = Number(Object.entries(discount)[0][1]);
      }
    });
    console.log('return finalDiscount: ===>>>', finalDiscount);
    return finalDiscount;
  }


  function priceFromMarket(marketsPrice, currentMarketplace) {
    const currentMarket = marketsPrice?.find(market => market.countryCode === currentMarketplace);
    const price = currentMarket?.price;
    const currencyCode = currentMarket?.currencyCode;
    return { price, currencyCode };
  }

  function isAvailableForSale(childProduct) {
    if (childProduct.variantDetails?.availableForSale === false) {
      return false;
    }

    let maxQuantity = 0;

    childProduct.variantDetails?.inventoryLevels?.forEach(level => {
      if (level.quantity > maxQuantity) {
        maxQuantity = level.quantity;
      }
    });

    if (childProduct.variantDetails?.inventoryPolicy === 'deny' && maxQuantity <= 0) {
      return false;
    }

    return true;
  }

  (function() {
    const widgetId = '{{ block.settings.widget_id }}';
    const appUrl = '{{ block.settings.app_url }}';
    const currentProductId = '{{ product.id }}';
    const statusElement = document.getElementById('sellence-status-{{ block.id }}');
    const contentElement = document.getElementById('sellence-widget-content-{{ block.id }}');
    let howManyProductsPicked = 0;

    // Функция для добавления выбранных товаров в корзину
    async function addSelectedItemsToCart(widget) {
      const checkedCheckboxes = document.querySelectorAll('#items-list .sellence-widget-checkbox:checked');

      if (checkedCheckboxes.length === 0) {
        alert('Please select at least one product');
        return;
      }

      // Собираем variantId из выбранных товаров
      const variantIds = [];
      checkedCheckboxes.forEach((checkbox) => {
        const contentEl = checkbox.closest('label')?.querySelector('.sellence-widget-item-content');
        if (!contentEl) return;
        const encoded = contentEl.getAttribute('data-product');
        if (!encoded) return;

        try {
          const childProduct = JSON.parse(decodeURIComponent(encoded));
          const variantId = childProduct.variantId || childProduct.variantDetails?.id;
          if (variantId) {
            variantIds.push(variantId);
          }
        } catch (error) {
          console.error('Error parsing product data:', error);
        }
      });

      if (variantIds.length === 0) {
        alert('No valid products selected');
        return;
      }

      try {
        // Отправляем запрос на сервер для вычисления скидки
        const cleanUrl = appUrl.replace(/\/$/, '');
        const discountResponse = await fetch(`${cleanUrl}/api/cart/calculate-discount`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            variantIds: variantIds,
            widgetId: widgetId,
            parentProductId: currentProductId
          })
        });

        if (!discountResponse.ok) {
          const errorData = await discountResponse.json();
          throw new Error(errorData.error || 'Failed to calculate discount');
        }

        const discountData = await discountResponse.json();

        if (!discountData.success) {
          throw new Error(discountData.error || 'Failed to calculate discount');
        }

        const discount = discountData.discount;

        // Функция для извлечения числового ID из GID формата
        function extractNumericId(gid) {
          if (!gid) return null;
          // Если уже числовой ID, возвращаем как есть
          if (/^\d+$/.test(gid)) return gid;
          // Извлекаем числовой ID из GID формата: gid://shopify/ProductVariant/43622958399581
          const match = gid.match(/\/(\d+)$/);
          return match ? match[1] : null;
        }

        // Формируем товары для добавления в корзину с properties
        const cartItems = variantIds.map((variantId) => {
          const numericId = extractNumericId(variantId);
          if (!numericId) {
            throw new Error(`Invalid variant ID format: ${variantId}`);
          }

          return {
            id: numericId,
            quantity: 1,
            properties: {
              '_sellence_discount': 'true',
              '_sellence_discount_percent': discount.toString(),
              '_sellence_widget_id': widgetId,
              '_sellence_applied': 'true'
            }
          };
        });

        // Добавляем товары в корзину через Shopify Cart API
        const addToCartResponse = await fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: cartItems })
        });

        if (!addToCartResponse.ok) {
          // Получаем детали ошибки от Shopify
          const errorData = await addToCartResponse.json().catch(() => ({ error: 'Unknown error' }));
          console.error('Shopify Cart API error:', errorData);
          throw new Error(`${I18N.addToCartError}: ${errorData.description || errorData.error || addToCartResponse.statusText}`);
        }

        // Перенаправляем на страницу корзины
        window.location.href = '/cart';
      } catch (error) {
        console.error('Error adding items to cart:', error);
        alert(`${I18N.addToCartError}: ${error instanceof Error ? error.message : 'Unknown error'}`);
      }
    }

    // Инициализация Splide.js слайдера
    function initSlider() {
      if (typeof Splide !== 'undefined') {
        new Splide('#products-slider', {
          type: 'slide',
          perPage: 4,
          perMove: 1,
          gap: '20px',
          // padding: '10px',
          arrows: false,
          pagination: false,
          drag: true,
          snap: true,
          breakpoints: {
            1240: {
              perPage: 2,
            },
            1024: {
              perPage: 1,
            }
          }
        }).mount();
      }
    }

    // Инициализируем слайдер после загрузки DOM
    document.addEventListener('DOMContentLoaded', initSlider);

    async function loadWidget() {
      console.log('loadWidget');
      try {
        console.log('loadWidget try');
        const cleanUrl = appUrl.replace(/\/$/, '');
        const apiUrl = cleanUrl + '/api/widget/' + widgetId + '?productId=' + encodeURIComponent(currentProductId);

        const response = await fetch(apiUrl);
        console.log('response:', response);

        if (!response.ok) {
          throw new Error('HTTP error! status: ' + response.status);
        }
        console.log('response ok');
        const data = await response.json();
        console.log('data:', data);

        const initializeWidget = (widget) => {
          let productSelectedCount = widget.product.childProducts.length;

          if (widget.product.childProducts.length > 0) {
            document.querySelector('.sellence-widget-{{ block.settings.widget_id }}').style.display = 'block';
          } else {
            console.log('no child products');
            return;
          }

          console.log('Sellence widget data:', data);

          const sortedDiscounts = widget.settings.discounts
          let finalDiscount = getFinalDiscount(productSelectedCount, sortedDiscounts);

          // Получаем текущий маркетплейс
          const currentMarketplace = document.getElementById('sellence-widget-{{ block.id }}').dataset.currentMarketplace || 'US';
          console.log('Current marketplace:', currentMarketplace);

          // Инициализируем слайдер с товарами
          initializeProductsSlider(widget, currentMarketplace);

          // Инициализируем список товаров
          initializeItemsList(widget, currentMarketplace, finalDiscount);

          // Обновляем общую цену
          updateTotalPrice(widget, currentMarketplace, finalDiscount);

          // Привязываем обработчик к кнопке "Add to cart"
          const buyButton = document.querySelector('.sellence-widget-add-to-cart');
          if (buyButton) {
            // Удаляем предыдущие обработчики, если есть
            buyButton.replaceWith(buyButton.cloneNode(true));
            const newBuyButton = document.querySelector('.sellence-widget-add-to-cart');
            if (newBuyButton) {
              newBuyButton.addEventListener('click', () => {
                addSelectedItemsToCart(widget);
              });
            }
          }
        }

        // Функция для создания слайдера с товарами
        function initializeProductsSlider(widget, currentMarketplace) {
          const productsList = document.getElementById('products-list');
          if (!productsList || !widget.product?.childProducts) return;

          // Очищаем список
          productsList.innerHTML = '';

          let indexOfAvailableProducts = 0;

          // Добавляем товары в слайдер
          widget.product.childProducts.forEach((childProduct, index) => {
            if (!isAvailableForSale(childProduct) || indexOfAvailableProducts >= widget.settings.slideCount) {
              return null;
            }

            indexOfAvailableProducts++;

            const slide = document.createElement('li');
            slide.className = 'splide__slide';

            // Получаем цену для текущего маркетплейса
            const inventoryLevel = childProduct.variantDetails?.inventoryLevels?.find(
              level => level.countryCode === currentMarketplace
            ) || childProduct.variantDetails?.inventoryLevels?.[0];

            const imageUrl = childProduct.variantDetails?.image?.url || 
                           'https://via.placeholder.com/120x120?text=No+Image';
            const imageAlt = I18N.noImageAlt.replace('{index}', (index + 1).toString());

            slide.innerHTML = `
              <div class="sellence-pdp-widget-product-image">
                <img src="${imageUrl}" alt="${imageAlt}" width="120" height="120">
              </div>
            `;

            productsList.appendChild(slide);
          });

          // Переинициализируем слайдер
          if (typeof Splide !== 'undefined') {
            const splideElement = document.querySelector('#products-slider');
            if (splideElement) {
              // Уничтожаем существующий слайдер если есть
              if (splideElement.splide) {
                splideElement.splide.destroy();
              }

              // Создаем новый слайдер
              new Splide('#products-slider', {
                type: 'slide',
                perPage: Math.min(4, widget.product.childProducts.length),
                perMove: 1,
                gap: '20px',
                arrows: false,
                pagination: false,
                drag: true,
                snap: true,
                breakpoints: {
                  1240: {
                    perPage: Math.min(2, widget.product.childProducts.length),
                  },
                  1024: {
                    perPage: 1,
                  }
                }
              }).mount();
            }
          }
        }

        // Перестраиваем слайдер из выбранных товаров
        function rebuildProductsSliderFromChecked(currentMarketplace) {
          const productsList = document.getElementById('products-list');
          if (!productsList) return;

          // Собираем данные из отмеченных элементов списка
          const checkedCheckboxes = document.querySelectorAll('#items-list .sellence-widget-checkbox:checked');
          const selectedProducts = Array.from(checkedCheckboxes).map((checkbox) => {
            const contentEl = checkbox.closest('label')?.querySelector('.sellence-widget-item-content');
            if (!contentEl) return null;
            const encoded = contentEl.getAttribute('data-product');
            if (!encoded) return null;
            try {
              return JSON.parse(decodeURIComponent(encoded));
            } catch (_) {
              return null;
            }
          }).filter(Boolean);

          // Очищаем текущий список слайдов
          productsList.innerHTML = '';

          // Добавляем слайды по выбранным товарам
          selectedProducts.forEach((childProduct, index) => {
            const slide = document.createElement('li');
            slide.className = 'splide__slide';

            const imageUrl = childProduct?.variantDetails?.image?.url || 
                           'https://via.placeholder.com/120x120?text=No+Image';
            const imageAlt = I18N.noImageAlt.replace('{index}', (index + 1).toString());

            slide.innerHTML = `
              <div class="sellence-pdp-widget-product-image">
                <img src="${imageUrl}" alt="${imageAlt}" width="120" height="120">
              </div>
            `;

            productsList.appendChild(slide);
          });

          // Переинициализируем Splide
          if (typeof Splide !== 'undefined') {
            const splideElement = document.querySelector('#products-slider');
            if (splideElement) {
              if (splideElement.splide) {
                splideElement.splide.destroy();
              }
              new Splide('#products-slider', {
                type: 'slide',
                perPage: Math.min(4, Math.max(1, selectedProducts.length)),
                perMove: 1,
                gap: '20px',
                arrows: false,
                pagination: false,
                drag: true,
                snap: true,
                breakpoints: {
                  1240: {
                    perPage: Math.min(2, Math.max(1, selectedProducts.length)),
                  },
                  1024: {
                    perPage: 1,
                  }
                }
              }).mount();
            }
          }
        }

        function addListenersToItemsList(itemsList, currentMarketplace, sortedDiscounts, widget) {
          itemsList.addEventListener('change', () => {
            const checkedCheckboxes = itemsList.querySelectorAll('.sellence-widget-checkbox:checked');
            // СНАЧАЛА обновляем количество выбранных, затем считаем скидку — иначе будет лаг на 1 шаг
            howManyProductsPicked = checkedCheckboxes.length;
            const finalDiscount = getFinalDiscount(howManyProductsPicked, sortedDiscounts);

            const selectedNames = Array.from(checkedCheckboxes).map((checkbox) => {
              const label = checkbox.closest('label');
              const nameEl = label ? label.querySelector('.sellence-widget-item-name') : null;
              return nameEl ? nameEl.textContent.trim() : '';
            }).filter(Boolean);

            const itemContents = itemsList.querySelectorAll('.sellence-widget-item-content');
            itemContents.forEach(itemContent => {
              const encoded = itemContent.getAttribute('data-product');
              if (!encoded) return;
              let childProduct;
              try {
                childProduct = JSON.parse(decodeURIComponent(encoded));
              } catch (_) {
                return;
              }
              const inventoryLevel = childProduct.variantDetails?.inventoryLevels?.find(
                level => level.countryCode === currentMarketplace
              ) || childProduct.variantDetails?.inventoryLevels?.[0];

              const price = parseFloat(priceFromMarket(childProduct.variantDetails?.marketsPrice, currentMarketplace)?.price || inventoryLevel?.price || childProduct?.variantDetails?.price || '0');
              const currencyCode = priceFromMarket(childProduct.variantDetails?.marketsPrice, currentMarketplace)?.currencyCode || inventoryLevel?.currencyCode || 'USD';
              const formattedPrice = formatWidgetPrice(price, currencyCode);
              const formattedPriceWithDiscount = formatWidgetPrice(price * (1 - finalDiscount / 100), currencyCode);

              const priceContainer = itemContent.querySelector('.sellence-widget-item-price');
              if (priceContainer) {
                const newPriceSpan = priceContainer.querySelector('p.sellence-widget-price-new > span.sellence-widget-price-new');
                const oldPriceSpan = priceContainer.querySelector('.sellence-widget-price-old-price');
                if (newPriceSpan) newPriceSpan.textContent = formattedPriceWithDiscount;
                if (oldPriceSpan) oldPriceSpan.textContent = formattedPrice;
              }
            });


            // Обновляем общую цену после пересчета скидки
            updateTotalPrice(widget, currentMarketplace, finalDiscount);

            // Обновляем слайдер по текущему набору выбранных товаров
            rebuildProductsSliderFromChecked(currentMarketplace);

            // console.log('Выбрано элементов:', howManyProductsPicked);
            // console.log('Список выбранных:', selectedNames);
          });
        }

        // Функция для создания списка товаров
        function initializeItemsList(widget, currentMarketplace, finalDiscount) {
          const itemsList = document.getElementById('items-list');
          if (!itemsList || !widget.product?.childProducts) return;

          // Очищаем список
          itemsList.innerHTML = '';

          let indexOfAvailableProducts = 0;

          // Добавляем товары в список
          widget.product.childProducts.forEach((childProduct, index) => {

            if (!isAvailableForSale(childProduct) || indexOfAvailableProducts >= widget.settings.slideCount) {
              return null;
            }

            indexOfAvailableProducts++;

            const item = document.createElement('li');
            item.className = 'sellence-widget-item';

            // Получаем цену для текущего маркетплейса
            const inventoryLevel = childProduct.variantDetails?.inventoryLevels?.find(
              level => level.countryCode === currentMarketplace
            ) || childProduct.variantDetails?.inventoryLevels?.[0];

            const price = priceFromMarket(childProduct.variantDetails?.marketsPrice, currentMarketplace)?.price || inventoryLevel?.price || childProduct.variantDetails?.price || '0';
            const currencyCode = priceFromMarket(childProduct.variantDetails?.marketsPrice, currentMarketplace)?.currencyCode || inventoryLevel?.currencyCode || 'USD';
            // const compareAtPrice = childProduct.variantDetails?.compareAtPrice;

            // Получаем название товара из данных варианта
            const fallbackName = I18N.productPlaceholder.replace('{index}', (index + 1).toString());
            const productName = childProduct.variantDetails?.product?.title || childProduct.variantDetails?.title || fallbackName;

            // Форматируем цены с символами валют
            const formattedPrice = formatWidgetPrice(price, currencyCode);
            const formattedPriceWithDiscount = formatWidgetPrice(price * (1 - finalDiscount / 100), currencyCode);
            // const formattedComparePrice = compareAtPrice ? formatWidgetPrice(compareAtPrice, currencyCode) : '';

            item.innerHTML = `
              <label class="sellence-widget-item-label">
                <input type="checkbox" class="sellence-widget-checkbox" checked>
                <span class="sellence-widget-checkmark"></span>
                <div class="sellence-widget-item-content" data-product="${encodeURIComponent(JSON.stringify(childProduct))}">
                  <span class="sellence-widget-item-name">${productName}</span>
                  <div class="sellence-widget-item-price">
                    <p class="sellence-widget-price-new">${I18N.nowLabel} <span class="sellence-widget-price-new">${formattedPriceWithDiscount}</span></p>
                    <p class="sellence-widget-price-old">${I18N.wasLabel} <span class="sellence-widget-price-old-price">${formattedPrice}</span></p>
                  </div>
                </div>
              </label>
            `;

            itemsList.appendChild(item);
          });

          howManyProductsPicked = widget?.product?.childProducts?.length || 0;

          addListenersToItemsList(itemsList, currentMarketplace, widget.settings.discounts, widget);
          console.log('How many products picked:', howManyProductsPicked);
        }

        // Функция для обновления общей цены
        function updateTotalPrice(widget, currentMarketplace, finalDiscount) {
          const totalPriceContainer = document.querySelector('.sellence-widget-total-price');
          const totalPriceNew = document.querySelector('.sellence-widget-total-price-new');
          const totalPriceOld = document.querySelector('.sellence-widget-total-price-old');

          if (!totalPriceNew || !totalPriceContainer) return;

          let totalNew = 0;
          let totalOld = 0;
          let currencyCode = 'USD';

          const checkedCheckboxes = document.querySelectorAll('#items-list .sellence-widget-checkbox:checked');
          const checkedCount = checkedCheckboxes.length;

          if (checkedCount === 0) {
            // Спрятать Total
            totalPriceContainer.style.display = 'none';

            // Найти скидку за 1 товар
            let oneItemDiscount = 0;
            (widget?.settings?.discounts || []).forEach((discount) => {
              const [threshold, value] = Object.entries(discount)[0] || [];
              if (Number(threshold) === 1) {
                oneItemDiscount = Number(value) || 0;
              }
            });

            // Создать/показать подсказку
            let promptEl = document.getElementById('sellence-widget-empty-prompt');
            if (!promptEl) {
              promptEl = document.createElement('p');
              promptEl.id = 'sellence-widget-empty-prompt';
              promptEl.style.margin = '0';
              promptEl.style.marginBottom = '16px';
              promptEl.style.fontWeight = '600';
              totalPriceContainer.parentElement?.insertBefore(promptEl, totalPriceContainer.nextSibling);
            }
            promptEl.textContent = oneItemDiscount > 0
              ? I18N.addMorePrompt.replace('{discount}', oneItemDiscount.toString())
              : I18N.addOnePrompt;

            return;
          } else {
            // Есть выбранные — удалить подсказку и показать Total
            const promptEl = document.getElementById('sellence-widget-empty-prompt');
            if (promptEl && promptEl.parentElement) {
              promptEl.parentElement.removeChild(promptEl);
            }
            totalPriceContainer.style.display = '';
          }

          checkedCheckboxes.forEach((checkbox, idx) => {
            const contentEl = checkbox.closest('label')?.querySelector('.sellence-widget-item-content');
            if (!contentEl) return;
            const encoded = contentEl.getAttribute('data-product');
            if (!encoded) return;
            let childProduct;
            try {
              childProduct = JSON.parse(decodeURIComponent(encoded));
            } catch (_) {
              return;
            }

            const inventoryLevel = childProduct?.variantDetails?.inventoryLevels?.find(
              (level) => level.countryCode === currentMarketplace
            ) || childProduct?.variantDetails?.inventoryLevels?.[0];

            const price = priceFromMarket(childProduct.variantDetails?.marketsPrice, currentMarketplace)?.price || parseFloat(inventoryLevel?.price || childProduct?.variantDetails?.price || '0');

            if (idx === 0 && (priceFromMarket(childProduct.variantDetails?.marketsPrice, currentMarketplace)?.currencyCode || inventoryLevel?.currencyCode)) {
              currencyCode = priceFromMarket(childProduct.variantDetails?.marketsPrice, currentMarketplace)?.currencyCode || inventoryLevel?.currencyCode || 'USD';
            }

            totalOld += price; // сумма без скидки только по выбранным
            totalNew += price * (1 - finalDiscount / 100); // сумма со скидкой только по выбранным
          });

          // Устанавливаем значения тоталов
          totalPriceNew.textContent = formatWidgetPrice(totalNew, currencyCode);
          if (totalOld > 0) {
            totalPriceOld.textContent = formatWidgetPrice(totalOld, currencyCode);
            totalPriceOld.style.display = 'inline';
          } else {
            totalPriceOld.textContent = '';
            totalPriceOld.style.display = 'none';
          }
        }

        const productPagePlacement = data?.widget?.settings?.placements?.includes('products');

        console.log('productPagePlacement:', productPagePlacement);

        if (data?.widget?.product?.parentProduct && productPagePlacement) {
          initializeWidget(data.widget);
        }

      } catch (error) {
        console.error('Error loading widget:', error);
        statusElement.innerHTML = '❌ Ошибка: ' + error.message;
        statusElement.className = 'text-red-600 font-medium';
      }


    }

    loadWidget();
  })();
</script>

{% schema %}
{
  "name": "Sellence Widget",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "widget_id",
      "label": "Widget ID",
      "info": "Enter the Widget ID from your Sellence app admin panel"
    },
    {
      "type": "text",
      "id": "app_url",
      "label": "App URL",
      "info": "Your app URL from terminal (e.g., https://abc123.cloudflare-tunnel.com)",
      "placeholder": "https://your-tunnel-url.com"
    }
  ]
}
{% endschema %}