{% comment %}
  Sellence Widget Block - Simple Start
{% endcomment %}

<!-- Splide.js CSS -->
{% comment %} theme-check-disable RemoteAsset {% endcomment %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/css/splide.min.css">

<!-- Splide.js JavaScript -->
{% comment %} theme-check-disable RemoteAsset {% endcomment %}
<script defer src="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/js/splide.min.js"></script>

<style>
  .sellence-widget-{{ block.settings.widget_id }} {
    display: none;
    margin-top: 16px;
    margin-bottom: 16px;
  }
  .product__media-wrapper {
    max-width: 50% !important;
  }

  .product__info-wrapper {
    max-width: 50% !important;
  }
  #sellence-widget-content {
    background-color: #f5f5ee;
    padding: 36px;
    border-radius:16px;
    display: flex;
    flex-direction: column;
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–∞ */
  .sellence-products-slider {
    width: 100%;
  }

  .sellence-products-slider .splide__slide {
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
  }

  .sellence-products-slider .splide__slide:not(:last-child)::after {
    content: '+';
    position: absolute;
    right: -15px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 20px;
    font-weight: bold;
    color: #666;
    z-index: 10;
  }

  .sellence-pdp-widget-product-image {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .sellence-pdp-widget-product-image img {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 8px;
  }

  /* –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Splide */
  .sellence-products-slider .splide__pagination {
    display: none !important;
  }

  .sellence-products-slider .splide__arrows {
    display: none !important;
  }

  .sellence-widget-title {
    font-size: 27px;
    font-weight: 500;
    margin: 0;
    color: #232323;
    line-height: 1;
    margin-bottom: 20px;
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ */
  .sellence-widget-this-item-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .sellence-widget-item {
    margin: 0;
  }

  .sellence-widget-item-label {
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    padding: 8px 0;
    margin: 0;
  }

  .sellence-widget-checkbox {
    display: none;
  }

  .sellence-widget-checkmark {
    width: 20px;
    height: 20px;
    background-color: #000;
    border-radius: 3px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-top: 2px;
  }

  .sellence-widget-checkmark::after {
    content: '‚úì';
    color: white;
    font-size: 14px;
    font-weight: bold;
  }

  .sellence-widget-checkbox:not(:checked) + .sellence-widget-checkmark {
    background-color: transparent;
    border: 2px solid #ccc;
  }

  .sellence-widget-checkbox:not(:checked) + .sellence-widget-checkmark::after {
    display: none;
  }

  .sellence-widget-item-content {
    display: flex;
    justify-content: space-between;
    /* flex-direction: column; */
    gap: 16px;
    flex: 1;
    width: 100%;
  }

  .sellence-widget-item-name {
    font-size: 14px;
    color: #333;
    text-decoration: underline;
    line-height: 1.3;
    display: flex;
    align-items: center;
  }

  .sellence-widget-item-price {
    display: flex;
    align-items: center;
    flex-direction: column;
    gap: 8px;
  }

  .sellence-widget-price-new {
    font-size: 14px;
    font-weight: 600;
    color: #e74c3c;
    margin: 0;
  }

  .sellence-widget-price-currency-code {
    font-size: 14px;
    font-weight: 600;
    color: #e74c3c;
  }

  .sellence-widget-price-old-currency-code {
    font-size: 14px;
    color: #999;
    text-decoration: line-through;
  }

  .sellence-widget-price-old {
    font-size: 14px;
    color: #999;
    text-decoration: line-through;
    margin: 0;
    display: flex;
    gap: 2px;
  }
  
  .sellence-widget-checkbox {
    display: none !important;
  }

  .sellence-widget-add-to-cart {
    padding: 10px 15px;
    width: 100%;
    height: auto;
    text-align: center;
    font-size: 16px;
    border-style: solid;
    border-width: 1px;
    border-color: #000;
    background-color: transparent;
    color: #000;
    font-weight: 500;
    cursor: pointer;
    width: 50%;
    margin-bottom: 20px;

    @media (max-width: 1024px) {
      width: 100%;
    }
  }

  .sellence-widget-product-label {
    font-size: 16px;
    font-weight: 500;
    color: #000;
    line-height: 1;
    margin: 0;
    margin-bottom: 16px;
  }

  .sellence-widget-total-price {
    margin-top: 16px;
    font-size: 15px;
    font-weight: 600;
    /* margin-left: 16px; */
  }

  .sellence-widget-total-price-new {
    font-weight: 400;
    color: red;
  }

  .sellence-widget-total-price-old {
    font-weight: 400;
    color: #8e8e8e;
    text-decoration: line-through;
  }
</style>

<div class="sellence-widget d sellence-widget-{{ block.settings.widget_id }}" id="sellence-widget-{{ block.id }}" data-current-marketplace="{{ localization.country.iso_code }}">
  <div id="sellence-widget-content" class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
    <h2 class="sellence-widget-title">{{ 'sellence-widget.title' | t }}</h2>

    <!-- Splide.js —Å–ª–∞–π–¥–µ—Ä -->
    <div class="splide sellence-products-slider" id="products-slider">
      <div class="splide__track">
        <ul class="splide__list" id="products-list">
          <!-- –¢–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JavaScript -->
        </ul>
      </div>
    </div>

    <p class="sellence-widget-total-price">{{ 'sellence-widget.total_price' | t }}
      <span class="sellence-widget-total-price-new"></span>
      <span class="sellence-widget-total-price-old"></span>
    </p>

    <button class="sellence-widget-add-to-cart">{{ 'sellence-widget.add_all' | t }}</button>

    <strong class="sellence-widget-product-label">{{ 'sellence-widget.this_item' | t }}</strong>

    <ul class="sellence-widget-this-item-list" id="items-list">
      <!-- –¢–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JavaScript -->
    </ul>
  </div>
</div>

<script>
  const CURRENCY_SYMBOLS = {
    'USD': '$', 'EUR': '‚Ç¨', 'GBP': '¬£', 'JPY': '¬•', 'CAD': 'C$',
    'AUD': 'A$', 'CHF': 'CHF', 'CNY': '¬•', 'SEK': 'kr', 'NOK': 'kr',
    'DKK': 'kr', 'PLN': 'z≈Ç', 'CZK': 'Kƒç', 'HUF': 'Ft', 'RUB': '‚ÇΩ',
    'BRL': 'R$', 'INR': '‚Çπ', 'KRW': '‚Ç©', 'SGD': 'S$', 'HKD': 'HK$',
    'NZD': 'NZ$', 'MXN': '$', 'ZAR': 'R', 'TRY': '‚Ç∫', 'ILS': '‚Ç™',
    'AED': 'ÿØ.ÿ•', 'SAR': 'Ô∑º', 'THB': '‡∏ø', 'MYR': 'RM', 'PHP': '‚Ç±',
    'IDR': 'Rp', 'VND': '‚Ç´', 'EGP': '¬£', 'NGN': '‚Ç¶', 'KES': 'KSh',
    'GHS': '‚Çµ', 'MAD': 'ÿØ.ŸÖ.', 'TND': 'ÿØ.ÿ™', 'DZD': 'ÿØ.ÿ¨', 'LBP': 'ŸÑ.ŸÑ',
    'JOD': 'ÿØ.ÿß', 'KWD': 'ÿØ.ŸÉ', 'BHD': 'ÿØ.ÿ®', 'QAR': 'ÿ±.ŸÇ', 'OMR': 'ÿ±.ÿπ.',
    'YER': 'Ô∑º', 'IQD': 'ÿØ.ÿπ', 'AFN': 'ÿã', 'PKR': '‚Ç®', 'BDT': '‡ß≥',
    'LKR': '‚Ç®', 'NPR': '‚Ç®', 'MMK': 'K', 'KHR': '·üõ', 'LAK': '‚Ç≠',
    'BND': 'B$', 'FJD': 'FJ$', 'PGK': 'K', 'SBD': 'SI$', 'VUV': 'Vt',
    'WST': 'WS$', 'TOP': 'T$', 'BTN': 'Nu.', 'MVR': 'ﬁÉ.', 'SCR': '‚Ç®',
    'MUR': '‚Ç®', 'KMF': 'CF', 'DJF': 'Fdj', 'ETB': 'Br', 'SOS': 'S',
    'TZS': 'TSh', 'UGX': 'USh', 'RWF': 'RF', 'BIF': 'FBu', 'MWK': 'MK',
    'ZMW': 'ZK', 'BWP': 'P', 'SZL': 'L', 'LSL': 'L', 'NAD': 'N$',
    'AOA': 'Kz', 'MZN': 'MT', 'MGA': 'Ar', 'CDF': 'FC', 'XAF': 'FCFA',
    'XOF': 'CFA', 'GMD': 'D', 'GNF': 'FG', 'LRD': 'L$', 'SLL': 'Le',
    'CVE': '$', 'STN': 'Db', 'ERN': 'Nfk', 'SDG': 'ÿ¨.ÿ≥.', 'SSP': '¬£',
    'LYD': 'ŸÑ.ÿØ', 'MRO': 'UM', 'MRU': 'UM', 'XPF': '‚Ç£', 'NIO': 'C$',
    'GTQ': 'Q', 'HNL': 'L', 'SVC': '$', 'BZD': 'BZ$', 'JMD': 'J$',
    'TTD': 'TT$', 'BBD': 'Bds$', 'XCD': '$', 'AWG': '∆í', 'ANG': '∆í',
    'SRD': '$', 'GYD': 'G$', 'VES': 'Bs.S', 'COP': '$', 'PEN': 'S/',
    'BOB': 'Bs', 'CLP': '$', 'ARS': '$', 'UYU': '$U', 'PYG': '‚Ç≤',
    'FKP': '¬£', 'GIP': '¬£', 'ISK': 'kr', 'RON': 'lei', 'BGN': '–ª–≤',
    'HRK': 'kn', 'RSD': '–¥–∏–Ω.', 'MKD': '–¥–µ–Ω', 'ALL': 'L', 'BAM': '–ö–ú',
    'MDL': 'L', 'UAH': '‚Ç¥', 'BYN': 'Br', 'AMD': '÷è', 'GEL': '‚Çæ',
    'AZN': '‚Çº', 'KZT': '‚Ç∏', 'KGS': '—Å', 'TJS': 'SM', 'TMT': 'T',
    'UZS': '–ª–≤', 'MNT': '‚ÇÆ'
  };

  const I18N = {
    nowLabel: {{ 'sellence-widget.price_now' | t | json }},
    wasLabel: {{ 'sellence-widget.price_was' | t | json }},
    addMorePrompt: {{ 'sellence-widget.add_more_prompt' | t | json }},
    addOnePrompt: {{ 'sellence-widget.add_one_prompt' | t | json }},
    productPlaceholder: {{ 'sellence-widget.product_placeholder' | t | json }},
    addToCartError: {{ 'sellence-widget.add_to_cart_error' | t | json }},
    noImageAlt: {{ 'sellence-widget.no_image_alt' | t | json }}
  };

  function getCurrencySymbol(currencyCode) {
    if (!currencyCode) return '';
    const symbol = CURRENCY_SYMBOLS[currencyCode.toUpperCase()];
    return symbol || currencyCode;
  }

  function formatWidgetPrice(amount, currencyCode) {
    const numericAmount = typeof amount === 'string' ? parseFloat(amount) : amount;
    if (isNaN(numericAmount)) return '0';

    console.log('numericAmount:', numericAmount);

    const formattedAmount = numericAmount.toFixed(2);
    const symbol = getCurrencySymbol(currencyCode);

    return `${symbol}${formattedAmount}`;
  }

  function getFinalDiscount(productSelectedCount, sortedDiscounts) {
    let finalDiscount = 0;
    sortedDiscounts.forEach(discount => {
      if (productSelectedCount >= Number(Object.entries(discount)[0][0])) {
        finalDiscount = Number(Object.entries(discount)[0][1]);
      }
    });
    console.log('return finalDiscount: ===>>>', finalDiscount);
    return finalDiscount;
  }


  function priceFromMarket(marketsPrice, currentMarketplace) {
    const currentMarket = marketsPrice?.find(market => market.countryCode === currentMarketplace);
    const price = currentMarket?.price;
    const currencyCode = currentMarket?.currencyCode;
    return { price, currencyCode };
  }

  function isAvailableForSale(childProduct) {
    // –ï—Å–ª–∏ availableForSale —è–≤–Ω–æ false, —Ç–æ–≤–∞—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
    if (childProduct.variantDetails?.availableForSale === false) {
      return false;
    }

    // –ï—Å–ª–∏ inventoryPolicy === "CONTINUE", —Ç–æ–≤–∞—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ –¥–∞–∂–µ –ø—Ä–∏ –Ω—É–ª–µ–≤–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ
    const inventoryPolicy = childProduct.variantDetails?.inventoryPolicy?.toUpperCase();
    if (inventoryPolicy === 'CONTINUE') {
      return true;
    }

    // –î–ª—è "DENY" –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–≤–∞—Ä–∞
    if (inventoryPolicy === 'DENY') {
      let maxQuantity = 0;
      childProduct.variantDetails?.inventoryLevels?.forEach(level => {
        if (level.quantity > maxQuantity) {
          maxQuantity = level.quantity;
        }
      });
      
      // –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ <= 0 –∏ –ø–æ–ª–∏—Ç–∏–∫–∞ DENY, —Ç–æ–≤–∞—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
      if (maxQuantity <= 0) {
        return false;
      }
    }

    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—á–∏—Ç–∞–µ–º —Ç–æ–≤–∞—Ä –¥–æ—Å—Ç—É–ø–Ω—ã–º, –µ—Å–ª–∏ availableForSale !== false
    return true;
  }

  (function() {
    const widgetId = '{{ block.settings.widget_id }}';
    const appUrl = '{{ block.settings.app_url }}';
    const currentProductId = '{{ product.id }}';
    const statusElement = document.getElementById('sellence-status-{{ block.id }}');
    const contentElement = document.getElementById('sellence-widget-content-{{ block.id }}');
    let howManyProductsPicked = 0;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
    async function hasPromoCodeInCart() {
      try {
        const cartResponse = await fetch('/cart.js');
        if (!cartResponse.ok) {
          console.warn('Failed to fetch cart, assuming no promo code');
          return false;
        }
        const cart = await cartResponse.json();
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞—Ç—Ä–∏–±—É—Ç–∞ _sellence_has_discount_code –≤ –∫–æ—Ä–∑–∏–Ω–µ
        const hasDiscountCode = cart.attributes && cart.attributes._sellence_has_discount_code;
        if (hasDiscountCode) {
          console.log('üéØ Promo code detected in cart:', hasDiscountCode);
        }
        return !!hasDiscountCode;
      } catch (error) {
        console.error('Error checking cart for promo code:', error);
        return false; // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –Ω–µ—Ç
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω—É
    async function addSelectedItemsToCart(widget) {
      const checkedCheckboxes = document.querySelectorAll('#items-list .sellence-widget-checkbox:checked');

      if (checkedCheckboxes.length === 0) {
        alert('Please select at least one product');
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º —Ç–æ–≤–∞—Ä–∞
      const hasPromoCode = await hasPromoCodeInCart();

      // –°–æ–±–∏—Ä–∞–µ–º variantId –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
      const variantIds = [];
      checkedCheckboxes.forEach((checkbox) => {
        const contentEl = checkbox.closest('label')?.querySelector('.sellence-widget-item-content');
        if (!contentEl) return;
        const encoded = contentEl.getAttribute('data-product');
        if (!encoded) return;

        try {
          const childProduct = JSON.parse(decodeURIComponent(encoded));
          const variantId = childProduct.variantId || childProduct.variantDetails?.id;
          if (variantId) {
            variantIds.push(variantId);
          }
        } catch (error) {
          console.error('Error parsing product data:', error);
        }
      });

      if (variantIds.length === 0) {
        alert('No valid products selected');
        return;
      }

      try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏
        const cleanUrl = appUrl.replace(/\/$/, '');
        const discountResponse = await fetch(`${cleanUrl}/api/cart/calculate-discount`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            variantIds: variantIds,
            widgetId: widgetId,
            parentProductId: currentProductId
          })
        });

        if (!discountResponse.ok) {
          const errorData = await discountResponse.json();
          throw new Error(errorData.error || 'Failed to calculate discount');
        }

        const discountData = await discountResponse.json();

        if (!discountData.success) {
          throw new Error(discountData.error || 'Failed to calculate discount');
        }

        const discount = discountData.discount;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —á–∏—Å–ª–æ–≤–æ–≥–æ ID –∏–∑ GID —Ñ–æ—Ä–º–∞—Ç–∞
        function extractNumericId(gid) {
          if (!gid) return null;
          // –ï—Å–ª–∏ —É–∂–µ —á–∏—Å–ª–æ–≤–æ–π ID, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
          if (/^\d+$/.test(gid)) return gid;
          // –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ–≤–æ–π ID –∏–∑ GID —Ñ–æ—Ä–º–∞—Ç–∞: gid://shopify/ProductVariant/43622958399581
          const match = gid.match(/\/(\d+)$/);
          return match ? match[1] : null;
        }

        // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É —Å properties
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–æ–≤ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º
        const cartItems = [];
        for (const variantId of variantIds) {
          const numericId = extractNumericId(variantId);
          if (!numericId) {
            console.warn(`Invalid variant ID format: ${variantId}`);
            continue;
          }

          // –ù–∞—Ö–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ inventoryPolicy
          let canAdd = true;
          checkedCheckboxes.forEach((checkbox) => {
            const contentEl = checkbox.closest('label')?.querySelector('.sellence-widget-item-content');
            if (!contentEl) return;
            const encoded = contentEl.getAttribute('data-product');
            if (!encoded) return;

            try {
              const childProduct = JSON.parse(decodeURIComponent(encoded));
              const currentVariantId = childProduct.variantId || childProduct.variantDetails?.id;
              if (currentVariantId === variantId) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
                const inventoryPolicy = childProduct.variantDetails?.inventoryPolicy?.toUpperCase();
                const availableForSale = childProduct.variantDetails?.availableForSale;
                
                // –ï—Å–ª–∏ inventoryPolicy === "CONTINUE", —Ç–æ–≤–∞—Ä –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–∞–∂–µ –ø—Ä–∏ –Ω—É–ª–µ–≤–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ
                if (inventoryPolicy === 'CONTINUE' && availableForSale !== false) {
                  canAdd = true;
                } else if (inventoryPolicy === 'DENY') {
                  // –î–ª—è DENY –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                  let maxQuantity = 0;
                  childProduct.variantDetails?.inventoryLevels?.forEach(level => {
                    if (level.quantity > maxQuantity) {
                      maxQuantity = level.quantity;
                    }
                  });
                  if (maxQuantity <= 0 || availableForSale === false) {
                    canAdd = false;
                  }
                } else if (availableForSale === false) {
                  canAdd = false;
                }
              }
            } catch (error) {
              console.error('Error parsing product data:', error);
            }
          });

          if (canAdd) {
            // –ü–æ–ª—É—á–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ marketsPrice –ø–æ —Ç–µ–∫—É—â–µ–º—É –º–∞—Ä–∫–µ—Ç—É
            const currentMarketplace = document.getElementById('sellence-widget-{{ block.id }}')?.dataset?.currentMarketplace || 'US';
            let originalPrice = null;
            let foundChildProduct = null;
            
            // –ò—â–µ–º —Ç–æ–≤–∞—Ä –≤ –≤–∏–¥–∂–µ—Ç–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω—ã
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ checkedCheckboxes (–±—ã—Å—Ç—Ä–µ–µ)
            checkedCheckboxes.forEach((checkbox) => {
              const contentEl = checkbox.closest('label')?.querySelector('.sellence-widget-item-content');
              if (!contentEl || foundChildProduct) return;
              const encoded = contentEl.getAttribute('data-product');
              if (!encoded) return;

              try {
                const childProduct = JSON.parse(decodeURIComponent(encoded));
                const currentVariantId = childProduct.variantId || childProduct.variantDetails?.id;
                if (currentVariantId === variantId) {
                  foundChildProduct = childProduct;
                }
              } catch (error) {
                console.error('Error parsing product data:', error);
              }
            });

            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ checkedCheckboxes, –∏—â–µ–º –≤ widget.product.childProducts
            if (!foundChildProduct && widget.product?.childProducts) {
              widget.product.childProducts.forEach((childProduct) => {
                if (foundChildProduct) return;
                const currentVariantId = childProduct.variantId || childProduct.variantDetails?.id;
                if (currentVariantId === variantId) {
                  foundChildProduct = childProduct;
                }
              });
            }

            // –ü–æ–ª—É—á–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ marketsPrice –ø–æ –º–∞—Ä–∫–µ—Ç—É
            if (foundChildProduct) {
              const marketPrice = priceFromMarket(foundChildProduct.variantDetails?.marketsPrice, currentMarketplace);
              if (marketPrice?.price) {
                originalPrice = marketPrice.price;
              } else {
                // Fallback –Ω–∞ –æ–±—ã—á–Ω—É—é —Ü–µ–Ω—É –µ—Å–ª–∏ –Ω–µ—Ç marketsPrice
                const inventoryLevel = foundChildProduct.variantDetails?.inventoryLevels?.find(
                  level => level.countryCode === currentMarketplace
                ) || foundChildProduct.variantDetails?.inventoryLevels?.[0];
                originalPrice = inventoryLevel?.price || foundChildProduct.variantDetails?.price || '0';
              }
            }

            if (originalPrice) {
              // –ï—Å–ª–∏ –≤ –∫–æ—Ä–∑–∏–Ω–µ –µ—Å—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥, –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã —Å–∫–∏–¥–∫–∏ Sellence
              // –¢–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏ –¥—Ä—É–≥–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã
              const itemProperties = {
                '_sellence_original_price': originalPrice.toString(),
                '_sellence_widget_id': widgetId,
                '_sellence_widget_type': 'products-page',
                '_sellence_applied': 'true'
              };

              // –î–æ–±–∞–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã —Å–∫–∏–¥–∫–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
              if (!hasPromoCode) {
                itemProperties['_sellence_discount'] = 'true';
                itemProperties['_sellence_discount_percent'] = discount.toString();
              } else {
                console.log(`‚è≠Ô∏è Skipping Sellence discount attributes for variant ${variantId} - promo code is active`);
              }

              cartItems.push({
                id: numericId,
                quantity: 1,
                properties: itemProperties
              });
            } else {
              console.warn(`Skipping variant ${variantId} - original price not found`);
            }
          } else {
            console.warn(`Skipping variant ${variantId} - not available for sale`);
          }
        }

        if (cartItems.length === 0) {
          throw new Error('No available products to add to cart');
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω—É —á–µ—Ä–µ–∑ Shopify Cart API
        const addToCartResponse = await fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: cartItems })
        });

        if (!addToCartResponse.ok) {
          // –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ –æ—Ç Shopify
          const errorData = await addToCartResponse.json().catch(() => ({ error: 'Unknown error' }));
          console.error('Shopify Cart API error:', errorData);
          
          // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å "sold out", –Ω–æ inventoryPolicy === "CONTINUE", 
          // —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Shopify
          const errorMessage = errorData.description || errorData.error || addToCartResponse.statusText;
          if (errorMessage.includes('sold out') || errorMessage.includes('already sold out')) {
            throw new Error(`${I18N.addToCartError}: Product may be temporarily unavailable. Please try again or contact support.`);
          }
          
          throw new Error(`${I18N.addToCartError}: ${errorMessage}`);
        }

        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–æ—Ä–∑–∏–Ω—ã
        window.location.href = '/cart';
      } catch (error) {
        console.error('Error adding items to cart:', error);
        alert(`${I18N.addToCartError}: ${error instanceof Error ? error.message : 'Unknown error'}`);
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Splide.js —Å–ª–∞–π–¥–µ—Ä–∞
    function initSlider() {
      if (typeof Splide !== 'undefined') {
        new Splide('#products-slider', {
          type: 'slide',
          perPage: 4,
          perMove: 1,
          gap: '20px',
          // padding: '10px',
          arrows: false,
          pagination: false,
          drag: true,
          snap: true,
          breakpoints: {
            1240: {
              perPage: 2,
            },
            1024: {
              perPage: 1,
            }
          }
        }).mount();
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ª–∞–π–¥–µ—Ä –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    document.addEventListener('DOMContentLoaded', initSlider);

    async function loadWidget() {
      console.log('loadWidget');
      try {
        console.log('loadWidget try');
        const cleanUrl = appUrl.replace(/\/$/, '');
        const apiUrl = cleanUrl + '/api/widget/' + widgetId + '?productId=' + encodeURIComponent(currentProductId);

        const response = await fetch(apiUrl);
        console.log('response:', response);

        if (!response.ok) {
          throw new Error('HTTP error! status: ' + response.status);
        }
        console.log('response ok');
        const data = await response.json();
        console.log('data:', data);

        const initializeWidget = (widget) => {
          let productSelectedCount = widget.product.childProducts.length;

          if (widget.product.childProducts.length > 0) {
            document.querySelector('.sellence-widget-{{ block.settings.widget_id }}').style.display = 'block';
          } else {
            console.log('no child products');
            return;
          }

          console.log('Sellence widget data:', data);

          const sortedDiscounts = widget.settings.discounts
          let finalDiscount = getFinalDiscount(productSelectedCount, sortedDiscounts);

          // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å
          const currentMarketplace = document.getElementById('sellence-widget-{{ block.id }}').dataset.currentMarketplace || 'US';
          console.log('Current marketplace:', currentMarketplace);

          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ª–∞–π–¥–µ—Ä —Å —Ç–æ–≤–∞—Ä–∞–º–∏
          initializeProductsSlider(widget, currentMarketplace);

          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
          initializeItemsList(widget, currentMarketplace, finalDiscount);

          // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Ü–µ–Ω—É
          updateTotalPrice(widget, currentMarketplace, finalDiscount);

          // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫ –∫–Ω–æ–ø–∫–µ "Add to cart"
          const buyButton = document.querySelector('.sellence-widget-add-to-cart');
          if (buyButton) {
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
            buyButton.replaceWith(buyButton.cloneNode(true));
            const newBuyButton = document.querySelector('.sellence-widget-add-to-cart');
            if (newBuyButton) {
              newBuyButton.addEventListener('click', () => {
                addSelectedItemsToCart(widget);
              });
            }
          }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–∞–π–¥–µ—Ä–∞ —Å —Ç–æ–≤–∞—Ä–∞–º–∏
        function initializeProductsSlider(widget, currentMarketplace) {
          const productsList = document.getElementById('products-list');
          if (!productsList || !widget.product?.childProducts) return;

          // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
          productsList.innerHTML = '';

          let indexOfAvailableProducts = 0;

          // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã –≤ —Å–ª–∞–π–¥–µ—Ä
          widget.product.childProducts.forEach((childProduct, index) => {
            if (!isAvailableForSale(childProduct) || indexOfAvailableProducts >= widget.settings.slideCount) {
              return null;
            }

            indexOfAvailableProducts++;

            const slide = document.createElement('li');
            slide.className = 'splide__slide';

            // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞
            const inventoryLevel = childProduct.variantDetails?.inventoryLevels?.find(
              level => level.countryCode === currentMarketplace
            ) || childProduct.variantDetails?.inventoryLevels?.[0];

            const imageUrl = childProduct.variantDetails?.image?.url || 
                           'https://via.placeholder.com/120x120?text=No+Image';
            const imageAlt = I18N.noImageAlt.replace('{index}', (index + 1).toString());

            slide.innerHTML = `
              <div class="sellence-pdp-widget-product-image">
                <img src="${imageUrl}" alt="${imageAlt}" width="120" height="120">
              </div>
            `;

            productsList.appendChild(slide);
          });

          // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ª–∞–π–¥–µ—Ä
          if (typeof Splide !== 'undefined') {
            const splideElement = document.querySelector('#products-slider');
            if (splideElement) {
              // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å–ª–∞–π–¥–µ—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
              if (splideElement.splide) {
                splideElement.splide.destroy();
              }

              // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Å–ª–∞–π–¥–µ—Ä
              new Splide('#products-slider', {
                type: 'slide',
                perPage: Math.min(4, widget.product.childProducts.length),
                perMove: 1,
                gap: '20px',
                arrows: false,
                pagination: false,
                drag: true,
                snap: true,
                breakpoints: {
                  1240: {
                    perPage: Math.min(2, widget.product.childProducts.length),
                  },
                  1024: {
                    perPage: 1,
                  }
                }
              }).mount();
            }
          }
        }

        // –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–ª–∞–π–¥–µ—Ä –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
        function rebuildProductsSliderFromChecked(currentMarketplace) {
          const productsList = document.getElementById('products-list');
          if (!productsList) return;

          // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–ø–∏—Å–∫–∞
          const checkedCheckboxes = document.querySelectorAll('#items-list .sellence-widget-checkbox:checked');
          const selectedProducts = Array.from(checkedCheckboxes).map((checkbox) => {
            const contentEl = checkbox.closest('label')?.querySelector('.sellence-widget-item-content');
            if (!contentEl) return null;
            const encoded = contentEl.getAttribute('data-product');
            if (!encoded) return null;
            try {
              return JSON.parse(decodeURIComponent(encoded));
            } catch (_) {
              return null;
            }
          }).filter(Boolean);

          // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ —Å–ª–∞–π–¥–æ–≤
          productsList.innerHTML = '';

          // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–∞–π–¥—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ç–æ–≤–∞—Ä–∞–º
          selectedProducts.forEach((childProduct, index) => {
            const slide = document.createElement('li');
            slide.className = 'splide__slide';

            const imageUrl = childProduct?.variantDetails?.image?.url || 
                           'https://via.placeholder.com/120x120?text=No+Image';
            const imageAlt = I18N.noImageAlt.replace('{index}', (index + 1).toString());

            slide.innerHTML = `
              <div class="sellence-pdp-widget-product-image">
                <img src="${imageUrl}" alt="${imageAlt}" width="120" height="120">
              </div>
            `;

            productsList.appendChild(slide);
          });

          // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Splide
          if (typeof Splide !== 'undefined') {
            const splideElement = document.querySelector('#products-slider');
            if (splideElement) {
              if (splideElement.splide) {
                splideElement.splide.destroy();
              }
              new Splide('#products-slider', {
                type: 'slide',
                perPage: Math.min(4, Math.max(1, selectedProducts.length)),
                perMove: 1,
                gap: '20px',
                arrows: false,
                pagination: false,
                drag: true,
                snap: true,
                breakpoints: {
                  1240: {
                    perPage: Math.min(2, Math.max(1, selectedProducts.length)),
                  },
                  1024: {
                    perPage: 1,
                  }
                }
              }).mount();
            }
          }
        }

        function addListenersToItemsList(itemsList, currentMarketplace, sortedDiscounts, widget) {
          itemsList.addEventListener('change', () => {
            const checkedCheckboxes = itemsList.querySelectorAll('.sellence-widget-checkbox:checked');
            // –°–ù–ê–ß–ê–õ–ê –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö, –∑–∞—Ç–µ–º —Å—á–∏—Ç–∞–µ–º —Å–∫–∏–¥–∫—É ‚Äî –∏–Ω–∞—á–µ –±—É–¥–µ—Ç –ª–∞–≥ –Ω–∞ 1 —à–∞–≥
            howManyProductsPicked = checkedCheckboxes.length;
            const finalDiscount = getFinalDiscount(howManyProductsPicked, sortedDiscounts);

            const selectedNames = Array.from(checkedCheckboxes).map((checkbox) => {
              const label = checkbox.closest('label');
              const nameEl = label ? label.querySelector('.sellence-widget-item-name') : null;
              return nameEl ? nameEl.textContent.trim() : '';
            }).filter(Boolean);

            const itemContents = itemsList.querySelectorAll('.sellence-widget-item-content');
            itemContents.forEach(itemContent => {
              const encoded = itemContent.getAttribute('data-product');
              if (!encoded) return;
              let childProduct;
              try {
                childProduct = JSON.parse(decodeURIComponent(encoded));
              } catch (_) {
                return;
              }
              const inventoryLevel = childProduct.variantDetails?.inventoryLevels?.find(
                level => level.countryCode === currentMarketplace
              ) || childProduct.variantDetails?.inventoryLevels?.[0];

              const price = parseFloat(priceFromMarket(childProduct.variantDetails?.marketsPrice, currentMarketplace)?.price || inventoryLevel?.price || childProduct?.variantDetails?.price || '0');
              const currencyCode = priceFromMarket(childProduct.variantDetails?.marketsPrice, currentMarketplace)?.currencyCode || inventoryLevel?.currencyCode || 'USD';
              const formattedPrice = formatWidgetPrice(price, currencyCode);
              const formattedPriceWithDiscount = formatWidgetPrice(price * (1 - finalDiscount / 100), currencyCode);

              const priceContainer = itemContent.querySelector('.sellence-widget-item-price');
              if (priceContainer) {
                const newPriceSpan = priceContainer.querySelector('p.sellence-widget-price-new > span.sellence-widget-price-new');
                const oldPriceSpan = priceContainer.querySelector('.sellence-widget-price-old-price');
                if (newPriceSpan) newPriceSpan.textContent = formattedPriceWithDiscount;
                if (oldPriceSpan) oldPriceSpan.textContent = formattedPrice;
              }
            });


            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Ü–µ–Ω—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å–∫–∏–¥–∫–∏
            updateTotalPrice(widget, currentMarketplace, finalDiscount);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–∞–π–¥–µ—Ä –ø–æ —Ç–µ–∫—É—â–µ–º—É –Ω–∞–±–æ—Ä—É –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
            rebuildProductsSliderFromChecked(currentMarketplace);

            // console.log('–í—ã–±—Ä–∞–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤:', howManyProductsPicked);
            // console.log('–°–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö:', selectedNames);
          });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
        function initializeItemsList(widget, currentMarketplace, finalDiscount) {
          const itemsList = document.getElementById('items-list');
          if (!itemsList || !widget.product?.childProducts) return;

          // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
          itemsList.innerHTML = '';

          let indexOfAvailableProducts = 0;

          // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã –≤ —Å–ø–∏—Å–æ–∫
          widget.product.childProducts.forEach((childProduct, index) => {

            if (!isAvailableForSale(childProduct) || indexOfAvailableProducts >= widget.settings.slideCount) {
              return null;
            }

            indexOfAvailableProducts++;

            const item = document.createElement('li');
            item.className = 'sellence-widget-item';

            // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞
            const inventoryLevel = childProduct.variantDetails?.inventoryLevels?.find(
              level => level.countryCode === currentMarketplace
            ) || childProduct.variantDetails?.inventoryLevels?.[0];

            const price = priceFromMarket(childProduct.variantDetails?.marketsPrice, currentMarketplace)?.price || inventoryLevel?.price || childProduct.variantDetails?.price || '0';
            const currencyCode = priceFromMarket(childProduct.variantDetails?.marketsPrice, currentMarketplace)?.currencyCode || inventoryLevel?.currencyCode || 'USD';
            // const compareAtPrice = childProduct.variantDetails?.compareAtPrice;

            // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞
            const fallbackName = I18N.productPlaceholder.replace('{index}', (index + 1).toString());
            const productName = childProduct.variantDetails?.product?.title || childProduct.variantDetails?.title || fallbackName;

            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—ã —Å —Å–∏–º–≤–æ–ª–∞–º–∏ –≤–∞–ª—é—Ç
            const formattedPrice = formatWidgetPrice(price, currencyCode);
            const formattedPriceWithDiscount = formatWidgetPrice(price * (1 - finalDiscount / 100), currencyCode);
            // const formattedComparePrice = compareAtPrice ? formatWidgetPrice(compareAtPrice, currencyCode) : '';

            item.innerHTML = `
              <label class="sellence-widget-item-label">
                <input type="checkbox" class="sellence-widget-checkbox" checked>
                <span class="sellence-widget-checkmark"></span>
                <div class="sellence-widget-item-content" data-product="${encodeURIComponent(JSON.stringify(childProduct))}">
                  <span class="sellence-widget-item-name">${productName}</span>
                  <div class="sellence-widget-item-price">
                    <p class="sellence-widget-price-new">${I18N.nowLabel} <span class="sellence-widget-price-new">${formattedPriceWithDiscount}</span></p>
                    <p class="sellence-widget-price-old">${I18N.wasLabel} <span class="sellence-widget-price-old-price">${formattedPrice}</span></p>
                  </div>
                </div>
              </label>
            `;

            itemsList.appendChild(item);
          });

          howManyProductsPicked = widget?.product?.childProducts?.length || 0;

          addListenersToItemsList(itemsList, currentMarketplace, widget.settings.discounts, widget);
          console.log('How many products picked:', howManyProductsPicked);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—â–µ–π —Ü–µ–Ω—ã
        function updateTotalPrice(widget, currentMarketplace, finalDiscount) {
          const totalPriceContainer = document.querySelector('.sellence-widget-total-price');
          const totalPriceNew = document.querySelector('.sellence-widget-total-price-new');
          const totalPriceOld = document.querySelector('.sellence-widget-total-price-old');

          if (!totalPriceNew || !totalPriceContainer) return;

          let totalNew = 0;
          let totalOld = 0;
          let currencyCode = 'USD';

          const checkedCheckboxes = document.querySelectorAll('#items-list .sellence-widget-checkbox:checked');
          const checkedCount = checkedCheckboxes.length;

          if (checkedCount === 0) {
            // –°–ø—Ä—è—Ç–∞—Ç—å Total
            totalPriceContainer.style.display = 'none';

            // –ù–∞–π—Ç–∏ —Å–∫–∏–¥–∫—É –∑–∞ 1 —Ç–æ–≤–∞—Ä
            let oneItemDiscount = 0;
            (widget?.settings?.discounts || []).forEach((discount) => {
              const [threshold, value] = Object.entries(discount)[0] || [];
              if (Number(threshold) === 1) {
                oneItemDiscount = Number(value) || 0;
              }
            });

            // –°–æ–∑–¥–∞—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É
            let promptEl = document.getElementById('sellence-widget-empty-prompt');
            if (!promptEl) {
              promptEl = document.createElement('p');
              promptEl.id = 'sellence-widget-empty-prompt';
              promptEl.style.margin = '0';
              promptEl.style.marginBottom = '16px';
              promptEl.style.fontWeight = '600';
              totalPriceContainer.parentElement?.insertBefore(promptEl, totalPriceContainer.nextSibling);
            }
            promptEl.textContent = oneItemDiscount > 0
              ? I18N.addMorePrompt.replace('{discount}', oneItemDiscount.toString())
              : I18N.addOnePrompt;

            return;
          } else {
            // –ï—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ ‚Äî —É–¥–∞–ª–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É –∏ –ø–æ–∫–∞–∑–∞—Ç—å Total
            const promptEl = document.getElementById('sellence-widget-empty-prompt');
            if (promptEl && promptEl.parentElement) {
              promptEl.parentElement.removeChild(promptEl);
            }
            totalPriceContainer.style.display = '';
          }

          checkedCheckboxes.forEach((checkbox, idx) => {
            const contentEl = checkbox.closest('label')?.querySelector('.sellence-widget-item-content');
            if (!contentEl) return;
            const encoded = contentEl.getAttribute('data-product');
            if (!encoded) return;
            let childProduct;
            try {
              childProduct = JSON.parse(decodeURIComponent(encoded));
            } catch (_) {
              return;
            }

            const inventoryLevel = childProduct?.variantDetails?.inventoryLevels?.find(
              (level) => level.countryCode === currentMarketplace
            ) || childProduct?.variantDetails?.inventoryLevels?.[0];

            const price = priceFromMarket(childProduct.variantDetails?.marketsPrice, currentMarketplace)?.price || parseFloat(inventoryLevel?.price || childProduct?.variantDetails?.price || '0');

            if (idx === 0 && (priceFromMarket(childProduct.variantDetails?.marketsPrice, currentMarketplace)?.currencyCode || inventoryLevel?.currencyCode)) {
              currencyCode = priceFromMarket(childProduct.variantDetails?.marketsPrice, currentMarketplace)?.currencyCode || inventoryLevel?.currencyCode || 'USD';
            }

            totalOld += price; // —Å—É–º–º–∞ –±–µ–∑ —Å–∫–∏–¥–∫–∏ —Ç–æ–ª—å–∫–æ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º
            totalNew += price * (1 - finalDiscount / 100); // —Å—É–º–º–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π —Ç–æ–ª—å–∫–æ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º
          });

          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Ç–æ—Ç–∞–ª–æ–≤
          totalPriceNew.textContent = formatWidgetPrice(totalNew, currencyCode);
          if (totalOld > 0) {
            totalPriceOld.textContent = formatWidgetPrice(totalOld, currencyCode);
            totalPriceOld.style.display = 'inline';
          } else {
            totalPriceOld.textContent = '';
            totalPriceOld.style.display = 'none';
          }
        }

        const productPagePlacement = data?.widget?.settings?.placements?.includes('products');

        console.log('productPagePlacement:', productPagePlacement);

        if (data?.widget?.product?.parentProduct && productPagePlacement) {
          initializeWidget(data.widget);
        }

      } catch (error) {
        console.error('Error loading widget:', error);
        statusElement.innerHTML = '‚ùå –û—à–∏–±–∫–∞: ' + error.message;
        statusElement.className = 'text-red-600 font-medium';
      }


    }

    loadWidget();
  })();
</script>

{% schema %}
{
  "name": "Sellence Widget",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "widget_id",
      "label": "Widget ID",
      "info": "Enter the Widget ID from your Sellence app admin panel"
    },
    {
      "type": "text",
      "id": "app_url",
      "label": "App URL",
      "info": "Your app URL from terminal (e.g., https://sellence-app-v1.fly.dev)",
      "default": "https://sellence-app-v1.fly.dev",
      "placeholder": "https://sellence-app-v1.fly.dev"
    }
  ]
}
{% endschema %}